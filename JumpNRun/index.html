<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>three.js - pointerlock controls</title>
		<style>
			html, body {
				width: 100%;
				height: 100%;
			}

            body {
                background-color: #9BEBFF;
                margin: 0;
                overflow: hidden;
                font-family: arial;
                background-image: url(images/background47.png);
                
            }

            #stickmanObject {
                position: absolute;
                width: 27.5px;
                height: 37.5px;
                background-image: url(images/stickmanSprite275right.png);
                background-position: 0px 0px;
            }

            .platform {
                width: 200px;
                height: 1px;
                border-top: 2px solid #621616;
                -webkit-transform: rotate(36deg);
                -moz-transform: rotate(36deg);
                -o-transform: rotate(36deg);
                -ms-transform: rotate(36deg);
                transform: rotate(36deg);
                position: absolute;
                bottom: 50px;
                left: 250px;
            }


		</style>
	</head>
	<body>
        <script src="js/box2d.js" type="text/javascript"></script>
        <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
        <script src="js/Platform.js" type="text/javascript"></script>
		
		<div id="stickmanObject" style="left: 50px; bottom: 550px;"></div>
        
	
		<script>
		
			requestAnimFrame = (function() {
			  return window.requestAnimationFrame ||
				 window.webkitRequestAnimationFrame ||
				 window.mozRequestAnimationFrame ||
				 window.oRequestAnimationFrame ||
				 window.msRequestAnimationFrame ||
				 function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
				   window.setTimeout(callback, 1000/60);
				 };
			})();
			

            // stickman's sprite animation
			//if (press)
            var stickmanObject = $('#stickmanObject');
			var stickmanSpritePosition = 0;
			setInterval(function() {				
			    stickmanSpritePosition--;
			    stickmanSpritePosition += 11;
				stickmanSpritePosition %= 11;

				stickmanObject.css('background-position-x', stickmanSpritePosition * 27.5);
			}, 100);

			var x = 0;
			setInterval(function () {
			    x -= 1;
			    $('body').css('background-position', x + 'px 0');
			}, 10);
			
			
			/***********************************PHYSICS*************************************/

			// 1 unit = 100 pixels

			var world = new Box2D.b2World(new Box2D.b2Vec2(0.0, -9.81));
			
			
			// stickman
			var bodyDef = new Box2D.b2BodyDef();
			bodyDef.set_type(Box2D.b2_dynamicBody);
			bodyDef.set_position( new Box2D.b2Vec2(0.2, 4.0) );
			var stickmanBody = world.CreateBody(bodyDef);
			stickmanBody.SetFixedRotation(true);
            
			
			var circleShape = new Box2D.b2CircleShape();
			
			var stickmanFixtureDef = new Box2D.b2FixtureDef();
			circleShape.set_m_radius( 0.05 );
			stickmanFixtureDef.set_density( 2.5 );
			stickmanFixtureDef.set_friction( 0.5 );
			stickmanFixtureDef.set_shape( circleShape );
			stickmanBody.CreateFixture(stickmanFixtureDef);
			
			
			// a platform
            
			var platform1 = new Platform(0, 3.5, 2, 3.5);
            var platform2 = new Platform(3, 4, 5, 4);
            var platform3 = new Platform(6, 4.5, 8, 4.5);
			var platform4 = new Platform(9, 5, 11, 5);
			/*var platform5 = new Platform(4, 5.5, 5, 5.5);
			var platform6 = new Platform(5, 6, 6, 6);
			var platform7 = new Platform(6, 6.5, 7, 6.5);
			var platform8 = new Platform(7, 7, 8, 7);*/
            
			
			// game loop

			var loop = {
			    step: function() { 
			        var stepRate = 1 / 120;
			        world.Step(stepRate, 10, 10);
			        //world.ClearForces();
			        platform1._update();
			        platform2._update();
			        platform3._update();
			        platform4._update();
			    },
			
			    update: function () {
			        var v = stickmanBody.GetLinearVelocity();
			        var impulse = new Box2D.b2Vec2(0, 0);			        
					
			        var v = stickmanBody.GetLinearVelocity();
			        v.set_x(1);
			        stickmanBody.SetLinearVelocity(v);

					//v.set_x(5);
					console.log(v.get_x());
					
					if (gameControls.right && v.get_x()<= 5) {

			            /*var force = stickmanBody.GetMass() * 1 / (1 / 60);
			            force /= 7.0;
			            stickmanBody.ApplyForce(new Box2D.b2Vec2(force, 0), stickmanBody.GetWorldCenter());*/
					    /*var v = stickmanBody.GetLinearVelocity();
					    v.set_x(1);
					    stickmanBody.SetLinearVelocity(v);*/
						
			        }

					if (gameControls.jump == true) {
					    impulse.set_y(stickmanBody.GetMass() * 5);
						gameControls.jump = false;
			        }
			   
			        if (gameControls.left) {
			            var v = stickmanBody.GetLinearVelocity();
			            v.set_x(-1);
			            stickmanBody.SetLinearVelocity(v);
			        }
					
			        stickmanBody.ApplyLinearImpulse(impulse, stickmanBody.GetWorldCenter());			        
			    },
				
			    draw: function() {
			        stickmanObject.css({
			            'bottom': stickmanBody.GetPosition().get_y() * 100,
                        'left': stickmanBody.GetPosition().get_x() * 100 - 7 // -7 because we want him centered
			        })
			    }
			};
            		

			var gameControls = {
			    right: false,
			    jump: false,
                left: false
			};
            				
			$(document).keydown(function( event ) {
				console.log('What is the key id of the key we are pressing? ', event.which);
				switch (event.which) {
					case 39:
					
					    //pressing the key to the right!
					    gameControls.right = true;
                     						                          
					    break;
				    case 32:
				        gameControls.jump = true;
				            
				        break;
				    case 37:
				        gameControls.left = true;
				        break;
				}
			});

			$(document).keyup(function( event ) {
				switch (event.which) {
					case 39:
					
					    //stop pressing the key to the right!
						//gameControls.right = false;
						
						break;
				    case 32:
				        gameControls.jump = false;
				        break;
				    case 37:
				        gameControls.left = false;
				        break;
				}
			});
			
			
            // START

			(function run() {
			    loop.step();
			    loop.update();
			    loop.draw();
			    requestAnimFrame(run);
			})();
			
		</script>
	</body>
</html>