<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>three.js - pointerlock controls</title>
		<style>
			html, body {
				width: 100%;
				height: 100%;
			}

            body {
                background-color: #9BEBFF;
                margin: 0;
                overflow: hidden;
                font-family: arial;
                background-image: url(images/backgroundlevel1-4.png);
                background-repeat: no-repeat;
            }

            #marioObject {
                position: absolute;
                width: 27.5px;
                height: 37.5px;
                background-image: url(images/stickmanSprite275right.png);
                background-position: 0px 0px;
            }

            /*#marioObject.left {
                position: absolute;
                width: 27.5px;
                height: 37.5px;
                background-image: url(images/stickmanSprite275left.png);
                background-position: 0px 0px;
            }*/

            #marioGround1 {
                position: absolute;
                bottom: 318px; /* 350 - 32 */
                left: -18px; /* 20 - 38 */
                width: 76px;
                height: 32px;
                background-image: url(images/marioSprite.png);
                background-position: -27px -228px;
            }


		</style>
	</head>
	<body>
        <script src="js/box2d.js" type="text/javascript"></script>
        <script src="js/jquery-1.10.2.min.js" type="text/javascript"></script>
		
		<div id="marioObject" style="left: 50px; bottom: 550px;"></div>
		
		<div id="marioGround1">
		</div>

		
		
		<script>
		
			requestAnimFrame = (function() {
			  return window.requestAnimationFrame ||
				 window.webkitRequestAnimationFrame ||
				 window.mozRequestAnimationFrame ||
				 window.oRequestAnimationFrame ||
				 window.msRequestAnimationFrame ||
				 function(/* function FrameRequestCallback */ callback, /* DOMElement Element */ element) {
				   window.setTimeout(callback, 1000/60);
				 };
			})();
			
			
            // mario's sprite animation
			//if (press)
            var marioObject = $('#marioObject');
			var marioSpritePosition = 0;
			setInterval(function() {				
			    marioSpritePosition--;
			    marioSpritePosition += 11;
				marioSpritePosition %= 11;

				marioObject.css('background-position-x', marioSpritePosition * 27.5);
			}, 50);


			
			/***********************************PHYSICS*************************************/

			

			var world = new Box2D.b2World(new Box2D.b2Vec2(0.0, -200.0));
			
			
			// mario
			var bodyDef = new Box2D.b2BodyDef();
			bodyDef.set_type(Box2D.b2_dynamicBody);
			bodyDef.set_position( new Box2D.b2Vec2(20.0, 400.0) );
			var marioBody = world.CreateBody(bodyDef);
			marioBody.SetFixedRotation(true);
			
			var circleShape = new Box2D.b2CircleShape();
			
			var marioFixtureDef = new Box2D.b2FixtureDef();
			circleShape.set_m_radius( 5 );
			marioFixtureDef.set_density( 2.5 );
			marioFixtureDef.set_friction( 0.5 );
			marioFixtureDef.set_shape( circleShape );
			marioBody.CreateFixture(marioFixtureDef);
			
						
			
			// a platform
			var Platform = function() {
			    
			}

			Platform.prototype.getPlatform = function (ax, ay, bx, by) {
			    var platformBodyDef = new Box2D.b2BodyDef();
			    platformBodyDef.set_position(new Box2D.b2Vec2(20.0, 350.0));

			    var groundBody = world.CreateBody(platformBodyDef);

			    var edgeShape = new Box2D.b2EdgeShape();
			    edgeShape.Set(new Box2D.b2Vec2(ax, ay), new Box2D.b2Vec2(bx, by));
			    var fixtureDef = new Box2D.b2FixtureDef();
			    fixtureDef.set_friction(1);
			    fixtureDef.set_shape(edgeShape);
			    groundBody.CreateFixture(fixtureDef);
		    
			}

			var platform1 = new Platform();
			platform1.getPlatform(-20, 0, 20, 0);
			/*platform1.getPlatform(20, 0, 60, 0);
            platform1.getPlatform(60, -30, 500, 100);
            platform1.getPlatform(500, -100, 700, -100);
            platform1.getPlatform(700, -150, 900, 0);*/
            

			/*var platformBodyDef = new Box2D.b2BodyDef();
			platformBodyDef.set_position( new Box2D.b2Vec2(20.0, 350.0) );
			
			var groundBody = world.CreateBody( platformBodyDef );
			
			var edgeShape = new Box2D.b2EdgeShape();
			edgeShape.Set( new Box2D.b2Vec2( -20, 0 ), new Box2D.b2Vec2( 20, 0 ) );
			var fixtureDef = new Box2D.b2FixtureDef();
			fixtureDef.set_friction( 1 );
			fixtureDef.set_shape( edgeShape );
			groundBody.CreateFixture( fixtureDef );*/
			
			
            
			
			// game loop

			var loop = {
			    step: function() { 
			        var stepRate = 1 / 60;
			        world.Step(stepRate, 10, 10);
			        //world.ClearForces();
			    },

			    
			
			    update: function () {            
			        if (gameControls.right) {

			            var force = marioBody.GetMass() * 10 / (1 / 60.0);
			            force /= 6.0;
			            marioBody.ApplyForce(new Box2D.b2Vec2(0, 10000), marioBody.GetWorldCenter());
			            
						/*var v = marioBody.GetLinearVelocity();
						v.set_x(200);
						marioBody.SetLinearVelocity(v);*/
						
			        }

			        if (gameControls.jump == true) {
			            var impulse = marioBody.GetMass() * 10;
			            marioBody.ApplyLinearImpulse(new Box2D.b2Vec2(0, impulse), marioBody.GetWorldCenter());

			        }
			   
			        if (gameControls.left) {
			            var v = marioBody.GetLinearVelocity();
			            v.set_x(-500);
			            marioBody.SetLinearVelocity(v);
			        }
			    },
			    draw: function() {
			        marioObject.css({
			            'bottom': marioBody.GetPosition().get_y(),
                        'left': marioBody.GetPosition().get_x() - 7 // -7 because we want him centered
			        })
			    }
			};
            		
			
			
			var gameControls = {
			    right: false,
			    jump: false,
                left: false
			};
            				
			$(document).keydown(function( event ) {
				console.log('What is the key id of the key we are pressing? ', event.which);
				switch (event.which) {
					case 39:
					
					    //pressing the key to the right!
					    gameControls.right = true;
                     						                          
					    break;
				    case 32:
				        gameControls.jump = true;
				             
				            
				        break;
				    case 37:
				        gameControls.left = true;
				        break;
				}
			});

			$(document).keyup(function( event ) {
				switch (event.which) {
					case 39:
					
					    //stop pressing the key to the right!
						gameControls.right = true;
						
						break;
				    case 32:
				        gameControls.jump = false;
				        break;
				    case 37:
				        gameControls.left = false;
				        break;
				}
			});
			
			
			
			// START
			

			(function run() {
			    loop.step();
			    loop.update();
			    loop.draw();
			    requestAnimFrame(run);
			})();
			
		</script>
	</body>
</html>
